(window.webpackJsonp=window.webpackJsonp||[]).push([[32],{457:function(s,t,a){"use strict";a.r(t);var n=a(27),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"_17-webapi：xmlhttprequest是怎么实现的"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_17-webapi：xmlhttprequest是怎么实现的"}},[s._v("#")]),s._v(" 17.Webapi：XMLHttpRequest是怎么实现的")]),s._v(" "),a("p",[s._v("在上一篇文章中我们介绍了 "),a("code",[s._v("setTimeout")]),s._v(" 是如何结合渲染进程的循环系统工作的，那本篇文章我们就继续介绍另外一种类型的 "),a("code",[s._v("WebAPI")]),s._v("——"),a("code",[s._v("XMLHttpRequest")]),s._v("。")]),s._v(" "),a("p",[s._v("自从网页中引入了 "),a("code",[s._v("JavaScript")]),s._v("，我们就可以操作 "),a("code",[s._v("DOM")]),s._v(" 树中任意一个节点，例如隐藏 / 显示节点、改变颜色、获得或改变文本内容、为元素添加事件响应函数等等， 几乎可以“为所欲为”了。")]),s._v(" "),a("p",[s._v("不过在 "),a("code",[s._v("XMLHttpRequest")]),s._v(" 出现之前，如果服务器数据有更新，依然需要重新"),a("strong",[s._v("刷新整个页面")]),s._v("。而"),a("code",[s._v("XMLHttpRequest")]),s._v(" 提供了从 "),a("code",[s._v("Web")]),s._v(" 服务器获取数据的能力，如果你想要更新某条数据，只需要通过 "),a("code",[s._v("XMLHttpRequest")]),s._v(" 请求服务器提供的"),a("strong",[s._v("接口")]),s._v("，就可以获取到服务器的数据，然后再操作 "),a("code",[s._v("DOM")]),s._v("来更新页面内容，整个过程"),a("strong",[s._v("只需要更新网页的一部分")]),s._v("就可以了，而不用像之前那样还得刷新整个页面，这样既有效率又不会打扰到用户。")]),s._v(" "),a("p",[s._v("关于 "),a("code",[s._v("XMLHttpRequest")]),s._v("，本来我是想一带而过的，后来发现这个 "),a("code",[s._v("WebAPI")]),s._v(" 用于教学非常好。首先前面讲了那么网络内容，现在可以通过它把 "),a("code",[s._v("HTTP")]),s._v(" 协议实践一遍；其次，"),a("code",[s._v("XMLHttpRequest")]),s._v(" 是一个非常典型的 "),a("code",[s._v("WebAPI")]),s._v("，通过它来讲解浏览器是如何实现 "),a("code",[s._v("WebAPI")]),s._v(" 的很合适，这对于你理解其他 "),a("code",[s._v("WebAPI")]),s._v(" 也有非常大的帮助，同时在这个过程中我们还可以把一些安全问题给串起来。")]),s._v(" "),a("p",[s._v("但在深入讲解 "),a("code",[s._v("XMLHttpRequest")]),s._v(" 之前，我们得先介绍下"),a("strong",[s._v("同步回调")]),s._v("和**异步回调 **这两个概念，这会帮助你更加深刻地理解 "),a("code",[s._v("WebAPI")]),s._v(" 是怎么工作的")]),s._v(" "),a("h2",{attrs:{id:"回调函数-vs-系统调用栈"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#回调函数-vs-系统调用栈"}},[s._v("#")]),s._v(" 回调函数 VS 系统调用栈")]),s._v(" "),a("p",[s._v("那什么是"),a("strong",[s._v("回调函数")]),s._v("呢（"),a("code",[s._v("Callback Function")]),s._v("）？")]),s._v(" "),a("p",[a("strong",[s._v("将一个函数作为参数")]),s._v("传递给另外一个函数，那作为"),a("strong",[s._v("参数")]),s._v("的这个函数就是"),a("strong",[s._v("回调函数")]),s._v("。简化的代码如下所示：")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("let")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[s._v("callback")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'i am do homework'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("doWork")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("cb")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'start do work'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cb")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'end do work'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("doWork")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("callback"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("在上面示例代码中，我们将一个匿名函数赋值给变量 "),a("code",[s._v("callback")]),s._v("，同时将 "),a("code",[s._v("callback")]),s._v(" 作为参数传递给了 "),a("code",[s._v("doWork()")]),s._v(" 函数，这时在函数 "),a("code",[s._v("doWork()")]),s._v("中 "),a("code",[s._v("callback")]),s._v(" 就是"),a("strong",[s._v("回调函数")]),s._v("。")]),s._v(" "),a("p",[s._v("上面的回调方法有个特点，就是回调函数 "),a("code",[s._v("callback")]),s._v(" 是在主函数 "),a("code",[s._v("doWork")]),s._v(" 返回之前执行的，我们把这个回调过程称为"),a("strong",[s._v("同步回调")]),s._v("。")]),s._v(" "),a("p",[s._v("既然有同步回调，那肯定也有"),a("strong",[s._v("异步回调")]),s._v("。下面我们再来看看异步回调的例子：")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("let")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[s._v("callback")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'i am do homework'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("doWork")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("cb")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'start do work'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("setTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("   \n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'end do work'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("doWork")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("callback"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("在这个例子中，我们使用了 "),a("code",[s._v("setTimeout")]),s._v(" 函数让 "),a("code",[s._v("callback")]),s._v(" 在 "),a("code",[s._v("doWork")]),s._v(" 函数执行结束后，又延时了 "),a("code",[s._v("1")]),s._v(" 秒再执行，这次 "),a("code",[s._v("callback")]),s._v(" 并没有在主函数 "),a("code",[s._v("doWork")]),s._v(" 内部被调用，我们把这种"),a("strong",[s._v("回调函数")]),s._v("在主函数"),a("strong",[s._v("外部执行")]),s._v("的过程称为"),a("strong",[s._v("异步回调")]),s._v("。")]),s._v(" "),a("p",[s._v("现在你应该知道什么是同步回调和异步回调了，那下面我们再深入点，站在消息循环的视角来看看同步回调和异步回调的区别。理解了这些，可以让你从本质上理解什么是回调。")]),s._v(" "),a("p",[s._v("我们还是先来回顾下页面的事件循环系统，通过《"),a("code",[s._v("15")]),s._v(" | 消息队列和事件循环：页面是怎么“活”起来的？》的学习，你应该已经知道浏览器页面是通过事件循环机制来驱动的，每个"),a("strong",[s._v("渲染进程")]),s._v("都有一个"),a("strong",[s._v("消息队列")]),s._v("，页面主线程按照顺序来执行消息队列中的事件，如执行 "),a("code",[s._v("JavaScript")]),s._v(" 事件、解析 "),a("code",[s._v("DOM")]),s._v(" 事件、计算布局事件、用户输入事件等等，如果页面有新的事件产生，那新的事件将会追加到事件队列的尾部。所以可以说是消息队列和主线程循环机制保证了页面有条不紊地运行。")]),s._v(" "),a("p",[s._v("这里还需要补充一点，那就是当循环系统在执行一个任务的时候，都要为这个任务维护一个系统调用栈。这个系统调用栈类似于 "),a("code",[s._v("JavaScript")]),s._v(" 的调用栈，只不过系统调用栈是 "),a("code",[s._v("Chromium")]),s._v("的开发语言 "),a("code",[s._v("C++")]),s._v(" 来维护的，其完整的调用栈信息你可以通过 "),a("code",[s._v("chrome://tracing/")]),s._v(" 来抓取。当然，你也可以通过 "),a("code",[s._v("Performance")]),s._v(" 来抓取它核心的调用信息，如下图所示：")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://ahuntsun.gitee.io/blogimagebed/img/browser/part4/ls17/1.png",alt:""}})]),s._v(" "),a("p",[s._v("这幅图记录了一个 "),a("code",[s._v("Parse HTML")]),s._v(" 的任务执行过程，其中黄色的条目表示执行 "),a("code",[s._v("JavaScript")]),s._v(" 的过程，其他颜色的条目表示浏览器内部系统的执行过程。")]),s._v(" "),a("p",[s._v("通过该图你可以看出来，"),a("code",[s._v("Parse HTML")]),s._v(" 任务在执行过程中会遇到一系列的子过程，比如在解析页面的过程中遇到了 "),a("code",[s._v("JavaScript")]),s._v(" 脚本，那么就暂停解析过程去执行该脚本，等执行完成之后，再恢复解析过程。然后又遇到了样式表，这时候又开始解析样式表……直到整个任务执行完成。")]),s._v(" "),a("p",[s._v("需要说明的是，整个 "),a("code",[s._v("Parse HTML")]),s._v(" 是一个完整的任务，在执行过程中的脚本解析、样式表解析都是该任务的子过程，其下拉的长条就是执行过程中调用栈的信息。")]),s._v(" "),a("p",[s._v("每个任务在执行过程中都有自己的"),a("strong",[s._v("调用栈")]),s._v("，那么同步回调就是在当前主函数的上下文中执行回调函数，这个没有太多可讲的。下面我们主要来看看异步回调过程，异步回调是指回调函数在主函数之外执行，一般有两种方式")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("第一种")]),s._v("：是把异步函数做成一个任务，添加到信息队列尾部；")]),s._v(" "),a("li",[a("strong",[s._v("第二种")]),s._v("：是把异步函数添加到"),a("strong",[s._v("微任务")]),s._v("队列中，这样就可以在当前任务的末尾处执行微任务了")])]),s._v(" "),a("h2",{attrs:{id:"xmlhttprequest-运作机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#xmlhttprequest-运作机制"}},[s._v("#")]),s._v(" "),a("code",[s._v("XMLHttpRequest")]),s._v(" 运作机制")]),s._v(" "),a("p",[s._v("理解了什么是同步回调和异步回调，接下来我们就来分析 "),a("code",[s._v("XMLHttpRequest")]),s._v(" 背后的实现机制，具体工作过程你可以参考下图：")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://ahuntsun.gitee.io/blogimagebed/img/browser/part4/ls17/2.png",alt:""}})]),s._v(" "),a("p",[s._v("这是 "),a("code",[s._v("XMLHttpRequest")]),s._v(" 的总执行流程图，下面我们就来分析从发起请求到接收数据的完整流程。")]),s._v(" "),a("p",[s._v("我们先从 "),a("code",[s._v("XMLHttpRequest")]),s._v(" 的用法开始，首先看下面这样一段请求代码：")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("GetWebData")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("URL")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n     * 1: 新建 XMLHttpRequest 请求对象\n     */")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("let")]),s._v(" xhr "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("XMLHttpRequest")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n \n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n     * 2: 注册相关事件回调处理函数 \n     */")]),s._v("\n    xhr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[s._v("onreadystatechange")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("switch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("xhr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("readyState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 请求未初始化")]),s._v("\n            console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('" 请求未初始化 "')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("OPENED")]),s._v("\n            console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"OPENED"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("HEADERS_RECEIVED")]),s._v("\n            console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"HEADERS_RECEIVED"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("LOADING")]),s._v("  \n            console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"LOADING"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("DONE")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("status "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("status "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("304")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("responseText"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n            console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"DONE"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n \n    xhr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[s._v("ontimeout")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("e")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ontimeout'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    xhr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[s._v("onerror")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("e")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'onerror'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n \n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n     * 3: 打开请求\n     */")]),s._v("\n    xhr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Get'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("URL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 创建一个 Get 请求, 采用异步")]),s._v("\n \n \n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n     * 4: 配置参数\n     */")]),s._v("\n    xhr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("timeout "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 设置 xhr 请求的超时时间")]),s._v("\n    xhr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("responseType "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"text"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 设置响应返回的数据格式")]),s._v("\n    xhr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("setRequestHeader")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"X_TEST"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"time.geekbang"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n \n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n     * 5: 发送请求\n     */")]),s._v("\n    xhr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("send")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br")])]),a("p",[s._v("上面是一段利用了 "),a("code",[s._v("XMLHttpRequest")]),s._v(" 来请求数据的代码，再结合上面的流程图，我们可以分析下这段代码是怎么执行的")]),s._v(" "),a("p",[a("strong",[s._v("第一步：创建 "),a("code",[s._v("XMLHttpRequest")]),s._v(" 对象。")])]),s._v(" "),a("p",[s._v("当执行到"),a("code",[s._v("let xhr = new XMLHttpRequest()")]),s._v("后，"),a("code",[s._v("JavaScript")]),s._v(" 会创建一个 "),a("code",[s._v("XMLHttpRequest")]),s._v(" 对象"),a("code",[s._v("xhr")]),s._v("，用来执行实际的网络请求操作。")]),s._v(" "),a("p",[a("strong",[s._v("第二步：为 "),a("code",[s._v("xhr")]),s._v(" 对象注册回调函数。")])]),s._v(" "),a("p",[s._v("因为网络请求比较耗时，所以要注册回调函数，这样后台任务执行完成之后就会通过调用回调函数来告诉其执行结果。")]),s._v(" "),a("p",[a("code",[s._v("XMLHttpRequest")]),s._v(" 的回调函数主要有下面几种：")]),s._v(" "),a("p",[a("code",[s._v("ontimeout")]),s._v("，用来"),a("strong",[s._v("监控超时请求")]),s._v("，如果后台请求超时了，该函数会被调用；\n"),a("code",[s._v("onerror")]),s._v("，用来"),a("strong",[s._v("监控出错信息")]),s._v("，如果后台请求出错了，该函数会被调用；\n"),a("code",[s._v("onreadystatechange")]),s._v("，用来"),a("strong",[s._v("监控后台请求过程中的状态")]),s._v("，比如可以监控到 "),a("code",[s._v("HTTP")]),s._v(" 头加载完成的消息、"),a("code",[s._v("HTTP")]),s._v(" 响应体消息以及数据加载完成的消息等。")]),s._v(" "),a("p",[a("strong",[s._v("第三步：配置基础的请求信息。")])]),s._v(" "),a("p",[s._v("注册好回调事件之后，接下来就需要配置基础的请求信息了，首先要通过 "),a("code",[s._v("open")]),s._v(" 接口配置一些基础的请求信息，包括"),a("strong",[s._v("请求的地址")]),s._v("、"),a("strong",[s._v("请求方法")]),s._v("（是 "),a("code",[s._v("get")]),s._v(" 还是 "),a("code",[s._v("post")]),s._v("）和"),a("strong",[s._v("请求方式")]),s._v("（"),a("strong",[s._v("同步")]),s._v("还是"),a("strong",[s._v("异步请求")]),s._v("）。")]),s._v(" "),a("p",[s._v("然后通过 "),a("code",[s._v("xhr")]),s._v(" 内部属性类配置一些其他可选的请求信息，你可以参考文中示例代码，我们通过"),a("code",[s._v("xhr.timeout = 3000")]),s._v("来配置超时时间，也就是说如果请求超过 "),a("code",[s._v("3000")]),s._v(" 毫秒还没有响应，那么这次请求就被判断为失败了。")]),s._v(" "),a("p",[s._v("我们还可以通过"),a("code",[s._v('xhr.responseType = "text"')]),s._v("来配置服务器返回的格式，将服务器返回的数据自动转换为自己想要的格式，如果将 "),a("code",[s._v("responseType")]),s._v(" 的值设置为 "),a("code",[s._v("json")]),s._v("，那么系统会自动将服务器返回的数据转换为 "),a("code",[s._v("JavaScript")]),s._v(" 对象格式。下面的图表是我列出的一些返回类型的描述：")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://ahuntsun.gitee.io/blogimagebed/img/browser/part4/ls17/3.png",alt:""}})]),s._v(" "),a("p",[s._v("假如你还需要添加自己专用的请求头属性，可以通过 "),a("code",[s._v("xhr.setRequestHeader")]),s._v(" 来添加。")]),s._v(" "),a("p",[a("strong",[s._v("第四步：发起请求。")])]),s._v(" "),a("p",[s._v("一切准备就绪之后，就可以调用"),a("code",[s._v("xhr.send")]),s._v("来发起网络请求了。你可以对照上面那张请求流程图，可以看到："),a("strong",[s._v("渲染进程")]),s._v("会将请求发送给"),a("strong",[s._v("网络进程")]),s._v("，然后网络进程负责资源的下载，等网络进程接收到数据之后，就会利用 "),a("code",[s._v("IPC")]),s._v(" 来通知"),a("strong",[s._v("渲染进程")]),s._v("；渲染进程接收到消息之后，会将 "),a("code",[s._v("xhr")]),s._v(" 的回调函数封装成任务并添加到消息队列中，等主线程循环系统执行到该任务的时候，就会根据相关的状态来调用对应的回调函数")]),s._v(" "),a("ul",[a("li",[s._v("如果网络请求出错了，就会执行 "),a("code",[s._v("xhr.onerror")]),s._v("；")]),s._v(" "),a("li",[s._v("如果超时了，就会执行 "),a("code",[s._v("xhr.ontimeout")]),s._v("；")]),s._v(" "),a("li",[s._v("如果是正常的数据接收，就会执行 "),a("code",[s._v("onreadystatechange")]),s._v(" 来反馈相应的状态。")])]),s._v(" "),a("p",[s._v("这就是一个完整的 "),a("code",[s._v("XMLHttpRequest")]),s._v(" 请求流程，如果你感兴趣，可以参考下 "),a("code",[s._v("Chromium")]),s._v(" 对 "),a("a",{attrs:{href:"https://chromium.googlesource.com/chromium/src/+/refs/heads/master/third_party/blink/renderer/core/xmlhttprequest/",target:"_blank",rel:"noopener noreferrer"}},[s._v("XMLHttpRequest 的实现"),a("OutboundLink")],1),s._v("，点击这里查看代码。")]),s._v(" "),a("h2",{attrs:{id:"xmlhttprequest-使用过程中的-坑"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#xmlhttprequest-使用过程中的-坑"}},[s._v("#")]),s._v(" "),a("code",[s._v("XMLHttpRequest")]),s._v(" 使用过程中的“坑”")]),s._v(" "),a("p",[s._v("上述过程看似简单，但由于浏览器很多安全策略的限制，所以会导致你在使用过程中踩到非常多的“坑”。")]),s._v(" "),a("p",[s._v("浏览器安全问题是前端工程师避不开的一道坎，通常在使用过程中遇到的“坑”，很大一部分都是由安全策略引起的，不管你喜不喜欢，它都在这里。本来很完美的一个方案，正是由于加了安全限制，导致使用起来非常麻烦。")]),s._v(" "),a("p",[s._v("而你要做的就是去正视这各种的安全问题。也就是说要想更加完美地使用 "),a("code",[s._v("XMLHttpRequest")]),s._v("，你就要了解浏览器的安全策略。")]),s._v(" "),a("p",[s._v("下面我们就来看看在使用 "),a("code",[s._v("XMLHttpRequest")]),s._v(" 的过程中所遇到的跨域问题和混合内容问题。")]),s._v(" "),a("p",[a("strong",[s._v("1. 跨域问题")])]),s._v(" "),a("p",[s._v("比如在极客邦的官网使用 "),a("code",[s._v("XMLHttpRequest")]),s._v(" 请求极客时间的页面内容，由于极客邦的官网是www.geekbang.org，极客时间的官网是"),a("code",[s._v("time.geekbang.org")]),s._v("，它们不是同一个源，所以就涉及到了跨域（在 "),a("code",[s._v("A")]),s._v(" 站点中去访问不同源的 "),a("code",[s._v("B")]),s._v(" 站点的内容）。默认情况下，"),a("strong",[s._v("跨域请求")]),s._v("是"),a("strong",[s._v("不被允许")]),s._v("的，你可以看下面的示例代码：")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),s._v(" xhr "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("XMLHttpRequest")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),s._v(" url "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://time.geekbang.org/'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("handler")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("switch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("xhr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("readyState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 请求未初始化")]),s._v("\n        console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('" 请求未初始化 "')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("OPENED")]),s._v("\n        console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"OPENED"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("HEADERS_RECEIVED")]),s._v("\n        console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"HEADERS_RECEIVED"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("LOADING")]),s._v("  \n        console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"LOADING"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("DONE")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("status "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("status "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("304")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("responseText"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"DONE"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n   \n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("callOtherDomain")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("xhr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("    \n    xhr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'GET'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" url"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    xhr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("onreadystatechange "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" handler\n    xhr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("send")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("callOtherDomain")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br")])]),a("p",[s._v("你可以在控制台测试下。首先通过浏览器打开www.geekbang.org，然后打开控制台，在控制台输入以上示例代码，再执行，会看到请求被 "),a("code",[s._v("Block")]),s._v(" 了。控制台的提示信息如下：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("Access to XMLHttpRequest at 'https://time.geekbang.org/' from origin 'https://www.geekbang.org' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("因为 www.geekbang.org 和 "),a("code",[s._v("time.geekbang.com")]),s._v(" 不属于一个域，所以以上访问就属于"),a("strong",[s._v("跨域访问")]),s._v("了，这次访问失败就是由于跨域问题导致的。")]),s._v(" "),a("p",[a("strong",[s._v("2. "),a("code",[s._v("HTTPS")]),s._v(" 混合内容的问题")])]),s._v(" "),a("p",[s._v("了解完跨域问题后，我们再来看看 "),a("code",[s._v("HTTPS")]),s._v(" 的混合内容。"),a("code",[s._v("HTTPS")]),s._v(" 混合内容是 "),a("code",[s._v("HTTPS")]),s._v(" 页面中包含了不符合 "),a("code",[s._v("HTTPS")]),s._v(" 安全要求的内容，比如包含了 "),a("code",[s._v("HTTP")]),s._v(" 资源，通过 "),a("code",[s._v("HTTP")]),s._v(" 加载的图像、视频、样式表、脚本等，都属于混合内容。")]),s._v(" "),a("p",[s._v("通常，如果 "),a("code",[s._v("HTTPS")]),s._v(" 请求页面中使用混合内容，浏览器会针对 "),a("code",[s._v("HTTPS")]),s._v("混合内容显示警告，用来向用户表明此 "),a("code",[s._v("HTTPS")]),s._v(" 页面包含不安全的资源。比如打开站点 https://www.iteye.com/groups ，可以通过控制台看到混合内容的警告，参考下图：")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://blog.poetries.top/img-repo/2019/11/38.png",alt:""}})]),s._v(" "),a("p",[s._v("从上图可以看出，通过 "),a("code",[s._v("HTML")]),s._v("文件加载的混合资源，虽然给出警告，但大部分类型还是能加载的。而使用 "),a("code",[s._v("XMLHttpRequest")]),s._v(" 请求时，浏览器认为这种请求可能是攻击者发起的，会阻止此类危险的请求。比如我通过浏览器打开地址 https://www.iteye.com/groups ，然后通过控制台，使用 "),a("code",[s._v("XMLHttpRequest")]),s._v(" 来请求 http://img-ads.csdn.net/2018/201811150919211586.jpg ，这时候请求就会报错，出错信息如下图所示：")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://ahuntsun.gitee.io/blogimagebed/img/browser/part4/ls17/5.png",alt:""}})]),s._v(" "),a("h2",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),a("p",[s._v("好了，今天我们就讲到这里，下面我来总结下今天的内容。")]),s._v(" "),a("p",[s._v("首先我们介绍了"),a("strong",[s._v("回调函数")]),s._v("和"),a("strong",[s._v("系统调用栈")]),s._v("；接下来我们站在循环系统的视角，分析了 "),a("code",[s._v("XMLHttpRequest")]),s._v(" 是怎么工作的；最后又说明了由于一些安全因素的限制，在使用 "),a("code",[s._v("XMLHttpRequest")]),s._v(" 的过程中会遇到跨域问题和混合内容的问题。")]),s._v(" "),a("p",[s._v("本篇文章跨度比较大，不是单纯地讲一个问题，而是将"),a("strong",[s._v("回调类型")]),s._v("、"),a("strong",[s._v("循环系统")]),s._v("、"),a("strong",[s._v("网络请求")]),s._v("和"),a("strong",[s._v("安全问题")]),s._v("“串联”起来了。")]),s._v(" "),a("p",[s._v("对比上一篇文章，"),a("code",[s._v("setTimeout")]),s._v(" 是直接将"),a("strong",[s._v("延迟任务")]),s._v("添加到"),a("strong",[s._v("延迟队列")]),s._v("中，而 "),a("code",[s._v("XMLHttpRequest")]),s._v(" 发起请求，是由浏览器的"),a("strong",[s._v("其他进程")]),s._v("或者"),a("strong",[s._v("线程")]),s._v("去"),a("strong",[s._v("执行")]),s._v("，然后再将执行结果利用 "),a("code",[s._v("IPC")]),s._v(" 的方式通知渲染进程，之后渲染进程再将对应的消息添加到"),a("strong",[s._v("消息队列")]),s._v("中。如果你搞懂了 "),a("code",[s._v("setTimeout")]),s._v(" 和 "),a("code",[s._v("XMLHttpRequest")]),s._v(" 的工作机制后，再来理解其他 "),a("code",[s._v("WebAPI")]),s._v(" 就会轻松很多了，因为大部分 "),a("code",[s._v("WebAPI")]),s._v(" 的工作逻辑都是类似的。")])])}),[],!1,null,null,null);t.default=e.exports}}]);