# 04.移动端300ms延迟

## 1. 300ms延迟的产生缘由

移动端浏览器的默认显示宽度是`980px`(不同机型各异，但相差不大)，而不是屏幕的宽度(`320px`或其他)。为了对早期普通网页更好的体验，`iphone`设计了双击放大显示的功能--这就是`300ms`延迟的来源：如果用户一次点击后`300ms`内没有其他操作，则认为是个单击行为；否则为双击放大行为。

## 2. 点透行为

假设有两个层级，`A`和`B`；`A`在上面，`B`在下面。 如果`A`监听`touch`事件(`zepto`的`tap`事件)，而且`B`上有个链接(或者监听`click`事件)，那么当`touch A`后，先后触发了`touchStart`和`touchEnd`事件，`touchEnd`后`A`层隐藏，而此刻会触发在`document`最前面`B`的`click`事件；这就是点透行为。

## 3. 解决方法

1. 设置不能缩放：`user-scalable=no`。 不能缩放就不会有双击缩放操作，因此`click`事件也就没了`300ms`延迟，这个是`Chrome`首先在`Android`中提出的。
2. 设置显示宽度：`width=device-width`。`Chrome` 开发团队[不久前宣布](https://link.jianshu.com/?t=https://groups.google.com/a/chromium.org/forum/#!topic/chromium-dev/8evES7o-QTY)，在 `Chrome 32` 这一版中，他们将[在包含 width=device-width 或者置为比 viewport 值更小的页面上禁用双击缩放](https://link.jianshu.com/?t=https://codereview.chromium.org/18850005/)。当然，没有双击缩放就没有 `300` 毫秒点击延迟。
3. `IE`的指针事件 (`Pointer Events`)：设置`touch-action:none`，根据[规范](https://link.jianshu.com/?t=https://dvcs.w3.org/hg/pointerevents/raw-file/tip/pointerEvents.html#the-touch-action-css-property)，`touch-action` 属性决定 *“是否触摸操作会触发用户代理的默认行为。这包括但不限于双指缩放等行为”*。
	从实际应用的角度来看，`touch-action`决定了用户在点击了目标元素之后，是否能够进行双指缩放或者双击缩放。因此，这也相当完美地解决了 `300` 毫秒点击延迟的问题。

鉴于上述的`3`种解决方案，现在较为通用的`meta`设置为：

```html
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
```

## 4. 现在的流行解决方案：

上述的`3`种解决方案可以解决`Chrome Android`和`IE10+`下的`300ms`问题，但是对**其他浏览器**还需要特定的解决方案。

1. 指针事件的 `polyfill`
	指针事件的 `polyfill` 比较多，以下列出比较流行的几个。`Google` 的 [Polymer](https://link.jianshu.com/?t=https://github.com/Polymer/PointerEvents)，微软的 [HandJS](https://link.jianshu.com/?t=http://handjs.codeplex.com/)和[@Rich-Harris](https://link.jianshu.com/?t=https://github.com/Rich-Harris) 的 [Points](https://link.jianshu.com/?t=https://github.com/Rich-Harris/Points)
2. **FastClick**
	[FastClick](https://link.jianshu.com/?t=https://github.com/ftlabs/fastclick) 是 [FT Labs](https://link.jianshu.com/?t=http://labs.ft.com/) 专门为解决移动端浏览器 `300` 毫秒点击延迟问题所开发的一个轻量级的库。简而言之，`FastClick` 在检测到 `touchend`事件的时候，会通过 [DOM 自定义事件](https://link.jianshu.com/?t=https://developer.mozilla.org/zh-CN/docs/Web/API/Event/createEvent)立即触发一个模拟`click`事件，并把浏览器在 `300` 毫秒之后真正触发的 `click`事件阻止掉。

## 5. FastClick

现阶段`FastClick`被更多使用，借助它通过监听`click`事件，即可消除`300ms`的问题。
通过阅读源码可知：

1. `FastClick`通过**判断浏览器类型**决定其是不是需要执行，下面几种场景下不会执行`FastClick`逻辑：

- 不支持`ontouchstart`事件的浏览器
- `Android Chrome` 或者 `firefox27`以上 设置了`user-scalable="no"`
- 满足特定要求的 `IE10+` 浏览器
- 部分黑莓浏览器

2. 注册了`touchStart`、`touchEnd`等事件，监听`touchStart`决定事件对象的`target`、时间、位置等信息；通过`touchEnd`得到`touch`的结束时间。如果`touch`时长大于`700ms`，则是长按事件；如果连续两次`touchEnd`的时间间隔小于`200ms`，那么认定为快速点击，特殊对待；排除上面两种情况，就通过`clickEvent = document.createEvent('MouseEvents'); initMouseEvent; dispatchEvent`手动触发`click`事件。